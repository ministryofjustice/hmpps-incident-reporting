{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "macros/renderDescriptions.njk" import renderDescriptions %}

{% if report.descriptionAddendums.length != 0 %}
  {% set descriptionHtml %}
    {{ renderDescriptions(report, usersLookup) }}
  {% endset %}
{% else %}
  {% set descriptionHtml = report.description | trim | escape | nl2br %}
{% endif %}

{% if descriptionAppendOnly %}
  {% set descriptionLink = reportUrl + "/add-description" %}
  {% set descriptionHiddenText = "description" %}
  {% set dateAndTimeLink = reportUrl + "/update-date-and-time" %}
  {% set dateAndTimeHiddenText = "incident date and time" %}
{% else %}
  {% set descriptionLink = reportUrl + "/update-details" %}
  {% set descriptionHiddenText = "incident summary" %}
  {% set dateAndTimeLink = reportUrl + "/update-details" %}
  {% set dateAndTimeHiddenText = "incident summary" %}
{% endif %}

{% set typeHtml %}
  {{ typesDescriptions[report.type] or report.type }}

  {% if report.incidentTypeHistory.length != 0 %}
    <div class="app-response--inset">
      {# incidentTypeHistory's entries are in chronological order, from older to newer changes, reverse to show newest changes on top #}
      {% for typeChange in incidentTypeHistory | reverse %}
        {% set actionDescription = "updated to" %}
        {# Last entry is for report creation #}
        {% if loop.index0 == incidentTypeHistory.length - 1 %}
          {% set actionDescription = "created as" %}
        {% endif %}

        Incident {{ actionDescription }} {{ typesDescriptions[typeChange.type] or typeChange.type }} by {{ usersLookup[typeChange.changedBy].name or type.changedBy }} on {{ typeChange.changedAt | longDateAndTime}} <br />
      {% endfor %}
    </div>
  {% endif %}
{% endset %}

{{ govukSummaryList({
  card: {
    title: { text: "Incident summary" }
  },
  rows: [
    {
      key: { text: "Type" },
      value: { html: typeHtml },
      actions: {
        items: [
          {
            href: reportUrl + "/change-type",
            text: "Change",
            visuallyHiddenText: "incident type"
          }
        ]
      } if canEditReport else {}
    },
    {
      key: { text: "Date and time of incident" },
      value: {
        text: report.incidentDateAndTime | longDateAndTime
      },
      actions: {
        items: [
          {
            href: dateAndTimeLink,
            text: "Change",
            visuallyHiddenText: dateAndTimeHiddenText
          }
        ]
      } if canEditReport else {}
    },
    {
      key: { text: "Description" },
      value: {
        html: descriptionHtml
      },
      actions: {
        items: [
          {
            href: descriptionLink,
            text: "Change",
            visuallyHiddenText: descriptionHiddenText
          }
        ]
      } if canEditReport else {}
    }
  ]
}) }}
