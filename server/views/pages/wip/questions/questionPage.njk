{% extends "../../../partials/layout.njk" %}

{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/textarea/macro.njk" import govukTextarea %}
{% from "moj/components/date-picker/macro.njk" import mojDatePicker %}


{% macro renderField(field) %}
  {% if field.component === "govukCheckboxes" %}
    {{ govukCheckboxes(field) }}
  {% elif field.component === "govukRadios" %}
    {% set items = [] %}
    {% for item in field.items %}
        {%- set conditionalHtml -%}
          {# TODO: How to identify this specific answer's comment/date? #}
          {#       This is particularly tricky when multiple answers are allowed! #}
          {#       Answers don't have an "id" #}
          {%- if item.dateRequired -%}
            {# TODO: Get value #}
            {# TODO: Validation? #}
            {# TODO: Handle errors #}
            {{ mojDatePicker({
                id: field.id + '-' + item.value + '-date',
                name: field.id + '-' + item.value + '-date',
                label: {
                  text: "Date"
                },
                value: formValues.dateRequiredTODO,
                leadingZeros: "true"
            }) }}
          {%- endif -%}

          {%- if item.commentRequired -%}
            {# TODO: How would this work with validation? #}
            {# TODO: See comments above on ID, etc...#}
            {{ govukInput({
              id: field.id + '-' + item.value + '-comment',
              name: field.id + '-' + item.value + '-comment',
              text: 'Comment',
              label: { text: 'Comment' },
              conditional: {
                html: conditionalHtml
              }
            }) }}
          {%- endif -%}
        {%- endset -%}

        {%- if item.dateRequired or item.commentRequired -%}
          {%- set conditional = { html: conditionalHtml} -%}
        {%- else -%}
          {%- set conditional = null -%}
        {%- endif -%}

        {% set items = (items.push({
          text: item.text,
          value: item.value,
          conditional: conditional
        }), items) %}
    {% endfor %}

    {{ govukRadios({
      name: field.name,
      fieldset: {
        legend: {
          text: field.text,
          classes: 'govuk-fieldset__legend--m'
        }
      },
      items: items
    })}}
  {% else %}
    <strong>WARNING: Unknown field's component {{ field.component }}
  {% endif %}
{% endmacro %}



{% set title = "TODO: Test nunjucks template" %}

{% block pageTitle %}
  TODO: Test nunjucks template
{% endblock %}

{% block beforeContent %}
  {% if backLink %}
    {{ govukBackLink({
      text: "Back",
      href: backLink
    }) }}
  {% endif %}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {% if errorlist.length %}
        {{ govukErrorSummary({
          titleText: "There is a problem",
          errorList: validationErrors,
          classes: "govuk-!-margin-top-7 govuk-!-margin-bottom-0"
        }) }}
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block content %}
  {% set formMethod = options.method | default('post') %}
  {% set formAction = options.action | default('') %}
  {% set formEnctype = options.enctype | default('') %}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <form method="{{ formMethod }}" action="{{ formAction }}"
          {% if formEnctype %}
            enctype="{{ formEnctype }}"
          {% endif %}
      >

        {% if formMethod == 'post' %}
          <input type="hidden" name="_csrf" value="{{ csrfToken }}">
        {% endif %}

        {% block fields %}
          {% for _fieldId, field in options.fields %}
            {% if field.component and not field.skip %}
              {{ renderField(field) }}
            {% endif %}
          {% endfor %}
        {% endblock %}

        <div class="govuk-button-group">
          {% block formActions %}
            {% block submitAction %}
              {{ govukButton({
                text: "Save and continue",
                classes: options.buttonClasses,
                preventDoubleClick: true,
                type: "submit"
              }) }}
            {% endblock %}

            {% block cancelAction %}
              {% if cancelUrl %}
                <a href="{{ cancelUrl }}" class="govuk-link--no-visited-state">
                  Cancel
                </a>
              {% endif %}
            {% endblock %}
          {% endblock %}
        </div>
      </form>

      <p>
        <a href="{{ cancelLink }}" class="govuk-link--no-visited-state">
          Cancel
        </a>
      </p>
    </div>
  </div>

  <h3>TODO: Debug</h3>
  <pre>
    req.form {{ req.form | dump(2) }}
    values {{ values | dump(2) }}
    fields {{ fields | dump(2) }}
    {# Cycle in options #}
    {# options {{ options | dump(2) }} #}
    options.step {{ options.step | dump(2) }}
    options.fields {{ options.fields | dump(2) }}
    action {{ action | dump(2) }}
    errors {{ errors | dump(2) }}
    nextPage {{ nextPage | dump(2) }}
  </pre>
{% endblock %}
